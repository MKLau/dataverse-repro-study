---
title: "Extract Dataverse Provenance Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting R file paths
First, we get the directory names within the dataset
```{r}
prov_dirs = dir("Rdatasets", pattern="doi*")
prov_dirs[1:10]
```

For each directory, we need to store the path to and names of the R files within the directory

```{r}
# intiialize the dataframe using junk values
prov_paths = data.frame(doi = c("foo"), filename = c("bar"), wd = c("fizz"),
                        stringsAsFactors = FALSE)
# iterate through directories
for (prov_dir in prov_dirs) {
  # get filenames
  prov_files = list.files(paste0("Rdatasets/", prov_dir), pattern="*.R", recursive=TRUE, full.names=FALSE)
  # store directory, filename, and path for each file
  for (prov_file in prov_files) {
    prov_paths = rbind(prov_paths, c(prov_dir, prov_file,
                                     paste0("Rdatasets/", prov_dir)))
  }
}
# remove the junk row used to initialize the dataframe
prov_paths = prov_paths[-1,]
head(prov_paths)
# write the dataframe to csv for use later
write.csv(prov_paths, "prov_paths.csv")
```


Import provR to capture the provenance, stringR for dealing with filenames
```{r}
library(provR)
library(stringr)
```

## Run provR on each file in the dataframe
First we create a directory to store the provenance data.
```{r}
# create directory to store provenance JSONS (or ignore warnings if it already exists)
dir.create("dataverse_provenance", showWarnings = FALSE)
```

We initialize a dataframe to store error output for each provenance computation, or NULL if there is none.
```{r}
prov_success = data.frame(doi = c("foo"), filename = c("bar"), error = c("fizz"),
                         stringsAsFactors = FALSE)
prov_success = prov_success[-1,]
# open output file for writing
write.csv(prov_success, file="prov_success.csv", row.names=FALSE)
```

Next, we iterate through the provenance path data frame and attempt to collect provenance data for each file.
```{r}
# iterate through the number of rows in prov_paths
for (i in (1:nrow(prov_paths))) {
  # parse out metadata about the R file
  myrow = prov_paths[i,]
  doi = myrow$doi
  filename = myrow$filename
  wd = myrow$wd
  cat(paste0(i, " out of ", nrow(prov_paths), " done\n"))
  # output path
  outpath = paste0("dataverse_provenance/", doi, "/")
  # save local variables for later access
  save(prov_paths, myrow, doi, filename, prov_paths, file="get_prov.RData")
  # set the working directory to that containing the R file
  setwd(wd)
  # capture provenance with error handling
  error = try(prov.capture(filename), silent = TRUE)[1]
  if (is.null(error)) {
    # create the folder to store provenance from specific DOI, ignoring warnings
    # if the file already exists
    dir.create(paste0("../../", outpath), showWarnings = FALSE)
    write(prov.json(), paste0("../../", outpath, "prov_", filename, ".json"))
    error = NA
  } 
  else {
    # trim whitespace from beginning and end of string
    error = str_trim(error)
    # parse all the quotes from the error string
    error = str_replace_all(error, "\"", "")
    # replace all newline characters in middle of string with special string
    error = str_replace_all(error, "[\n]", "[newline]")
  }
  # write errors (or null) to error recording file
  load("../../get_prov.RData")
  # create dataframe from doi, filename, and errors to facilitate csv writing
  new_error_data = data.frame(doi=c(doi), filename=c(filename), error=c(error),
                              stringsAsFactors = FALSE)
  write.table(new_error_data, file="../../prov_success.csv", sep=",", append=TRUE, 
              row.names=FALSE, col.names=FALSE)
  # set working directory back to the one containing this script
  # and reload the workspaces
  setwd("../../")
  load("get_prov.RData")
}
```

```{r}
prov_success$error
```

```{r}
# parse out metadata about the R file
myrow = prov_paths[1,]
doi = myrow$doi
filename = myrow$filename
wd = myrow$wd
# output path
outpath = paste0("dataverse_provenance/", doi, "/")
# create the folder to store provenance from specific DOI, ignoring warnings
# if the file already exists
dir.create(outpath, showWarnings = FALSE)
save.image(file="get_prov.RData")
# set the working directory to that containing the R file
setwd(wd)
# capture provenance with error handling
errors = try(prov.capture(filename), silent = TRUE)[1]
save.image(file="prov.RData")
# set working directory back to the one containing this script
setwd("../../")
# reload the workspaces
load("prov.RData")
load("get_prov.RData")
# if there are no errors, store provenance as JSON
if (is.null(errors)) {
  write(prov.json(), paste0(outpath, "prov_", filename, ".json"))
}
# store errors in error dataframe
prov_success = rbind(prov_success, c(doi, filename, errors))
```

