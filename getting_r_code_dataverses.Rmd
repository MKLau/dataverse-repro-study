---
title: "Getting R Dataverses"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preliminary Setup
Loading modules and setting relevant system variables
```{r}
library(dataverse)
library(stringr)
Sys.setenv("DATAVERSE_KEY" = "670994aa-dbf5-4240-a3a6-74cca05a9f07")
Sys.setenv("DATAVERSE_SERVER" = "dataverse.harvard.edu")
```

## Getting Dataverses associated with .R files
Dataverses appear to have unique identifiers called a "doi". This allows us to then query the dataverse API and get all the files in a dataverse, then download them by ID later. Thus, our approach will be:

1. Get metadata for ".R" files
2. Extract "doi" from the metadata
3. Use the "doi" to query the dataverse API for the correct dataverse
4. Record the id's of all files in the dataverse
5. Store the file id's to be used in a different script (probably in python) for downloading

#### 1. Getting metadata for .R files
```{r}
# trying out a dataverse search for .R files
rfiles = dataverse_search("*.R", type="file")
names(rfiles)

# We can get any page of results with the "start" parameter (0-indexed). 
# This should generate the same result as the above line
rfiles1 = dataverse_search("*.R", type="file", start=0)
setdiff(rfiles, rfiles1) # has no output if they are truly equal

# we want to record the number of .R files so we know how many pages of metadata to receive
# first we need to capture Y from the console message "X of Y results retrieved"
# we comment out this section because capturing doesn't properly work in RMarkdown
# captured_message = capture.output(query_result = dataverse_search("*.R" ,type="file")$name, type="message")

# use regex (with stringr module) to parse out the number of files and convert to integer
# num_files = as.numeric(str_extract_all(captured_message, "[0-9]+")[[1]][2])
# num_files
```

#### 2. Extract "doi" from the metadata
```{r}
# useful part of each search result, containing doi
example_citation = rfiles[1,]$dataset_citation
example_citation
# using stringr to get the doi
example_doi = str_extract(example_citation, "doi[^,]+")[[1]][1]
example_doi
```

#### 3. & 4. Querying API using doi and getting all file IDs
```{r}
# query the dataverse API for the dataset corresponding to the dataverse DOI
# obtain metadata
example_dataset_metadata = get_dataset(example_doi)
names(example_dataset_metadata)

# filter on the id column
example_dataset_metadata[13]$files$id
```